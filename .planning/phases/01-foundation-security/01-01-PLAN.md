---
phase: 01-foundation-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .gitignore
  - src/types.ts
  - docker/Dockerfile
  - docker/.dockerignore
autonomous: true

must_haves:
  truths:
    - "npm install succeeds without errors"
    - "TypeScript compiles without errors"
    - "Docker image builds successfully"
    - "Container starts with non-root user"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "dockerode"
    - path: "tsconfig.json"
      provides: "TypeScript configuration"
      contains: "strict"
    - path: "src/types.ts"
      provides: "Shared type definitions"
      exports: ["ContainerConfig", "AgentSession"]
    - path: "docker/Dockerfile"
      provides: "Agent sandbox image"
      contains: "USER agent"
  key_links:
    - from: "package.json"
      to: "node_modules"
      via: "npm install"
      pattern: "dockerode.*@anthropic-ai/sdk"
    - from: "docker/Dockerfile"
      to: "agent-sandbox:latest"
      via: "docker build"
      pattern: "USER agent"
---

<objective>
Initialize TypeScript project with dependencies and create secure Docker image for agent execution.

Purpose: Establish foundational project structure and build the sandboxed container image that agents will execute in. This is the bedrock for all subsequent work.

Output: Working npm project with dockerode + Anthropic SDK, plus buildable Docker image with non-root user, multi-runtime support (Node.js + Java/Maven), and security hardening.
</objective>

<execution_context>
@/Users/kiruba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kiruba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-RESEARCH.md

Key research findings to apply:
- Use dockerode 4.x for Docker API, @anthropic-ai/sdk for Claude
- Alpine 3.18+ base image for minimal attack surface
- Non-root user (agent:agent) with UID/GID 1001
- Multi-stage build for Node.js + Java/Maven support
- Exec-form CMD for proper signal handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize TypeScript project with dependencies</name>
  <files>
    package.json
    tsconfig.json
    .gitignore
    src/types.ts
  </files>
  <action>
1. Create package.json with:
   - name: "background-coding-agent"
   - version: "0.1.0"
   - type: "module" (ESM)
   - scripts: build, test, lint
   - dependencies: dockerode@^4.0.0, @anthropic-ai/sdk@latest
   - devDependencies: typescript@^5.0.0, @types/dockerode@latest, @types/node@^20

2. Create tsconfig.json with strict mode:
   - target: ES2022
   - module: NodeNext
   - moduleResolution: NodeNext
   - strict: true
   - outDir: dist
   - rootDir: src

3. Create/update .gitignore:
   - node_modules/
   - dist/
   - .env
   - *.log

4. Create src/types.ts with shared types:
   ```typescript
   export interface ContainerConfig {
     image: string;
     workspaceDir: string;
     memoryMB?: number;
     cpuCount?: number;
     timeoutSeconds?: number;
   }

   export interface AgentSession {
     id: string;
     containerId: string;
     workspaceDir: string;
     status: 'pending' | 'running' | 'success' | 'failed';
     startedAt: Date;
     endedAt?: Date;
   }

   export interface ToolResult {
     stdout: string;
     stderr: string;
     exitCode: number;
   }
   ```

5. Run npm install to verify dependencies resolve
  </action>
  <verify>
    - `npm install` completes without errors
    - `npx tsc --noEmit` shows no type errors
    - node_modules contains dockerode and @anthropic-ai/sdk
  </verify>
  <done>
    - package.json exists with correct dependencies
    - TypeScript compiles without errors
    - Types exported from src/types.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create secure multi-runtime Dockerfile</name>
  <files>
    docker/Dockerfile
    docker/.dockerignore
  </files>
  <action>
1. Create docker/Dockerfile with multi-stage build:

```dockerfile
# Stage 1: Node.js base with essential tools
FROM node:20-alpine3.18 AS nodejs-base

# Install bash, git, and CA certificates
RUN apk add --no-cache \
    bash \
    git \
    ca-certificates \
    ripgrep

# Stage 2: Add Java and Maven for future Maven task support
FROM nodejs-base AS multi-runtime

RUN apk add --no-cache \
    openjdk17-jre-headless \
    maven

# Stage 3: Final agent image with security hardening
FROM multi-runtime AS agent

# Create non-root user with specific UID/GID
RUN addgroup -g 1001 -S agent && \
    adduser -u 1001 -S agent -G agent -h /home/agent

# Create workspace directory
WORKDIR /workspace
RUN chown agent:agent /workspace

# Switch to non-root user
USER agent

# Use exec-form CMD for proper signal handling
# Container stays alive for docker exec commands
CMD ["sh", "-c", "sleep infinity"]
```

2. Create docker/.dockerignore:
```
node_modules
dist
*.log
.git
.env
```

3. Build the image to verify:
   `docker build -t agent-sandbox:latest -f docker/Dockerfile docker/`

4. Verify non-root user:
   `docker run --rm agent-sandbox:latest whoami` should output "agent"

5. Verify runtimes available:
   - `docker run --rm agent-sandbox:latest node --version`
   - `docker run --rm agent-sandbox:latest java -version`
   - `docker run --rm agent-sandbox:latest mvn --version`
  </action>
  <verify>
    - `docker build -t agent-sandbox:latest -f docker/Dockerfile docker/` succeeds
    - `docker run --rm agent-sandbox:latest whoami` outputs "agent"
    - `docker run --rm agent-sandbox:latest id` shows uid=1001(agent) gid=1001(agent)
  </verify>
  <done>
    - Docker image builds without errors
    - Image runs as non-root user (agent:agent, UID 1001)
    - Node.js, Java, Maven, git, ripgrep available in container
  </done>
</task>

</tasks>

<verification>
Run all verification commands:

```bash
# Project setup
npm install
npx tsc --noEmit

# Docker image
docker build -t agent-sandbox:latest -f docker/Dockerfile docker/
docker run --rm agent-sandbox:latest whoami
docker run --rm agent-sandbox:latest node --version
docker run --rm agent-sandbox:latest java -version
```

All commands should succeed without errors.
</verification>

<success_criteria>
1. `npm install` installs dockerode and @anthropic-ai/sdk without errors
2. `npx tsc --noEmit` passes with no type errors
3. Docker image builds successfully as agent-sandbox:latest
4. Container runs as non-root user agent (UID 1001)
5. Container has Node.js 20.x, Java 17, Maven, git, and ripgrep installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-01-SUMMARY.md`
</output>
