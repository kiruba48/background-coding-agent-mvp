---
phase: 03-agent-tool-access
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/orchestrator/session.test.ts
autonomous: true

must_haves:
  truths:
    - "Edit tool rejects paths with null bytes"
    - "Edit tool rejects paths to .git/hooks"
    - "Edit tool rejects paths outside workspace"
    - "Edit str_replace fails gracefully when old_str not found"
    - "Edit str_replace fails gracefully when old_str matches multiple locations"
    - "Edit str_replace succeeds when old_str matches exactly once"
    - "Edit create fails if file already exists"
    - "Git operation rejects unknown operations"
    - "Git commit uses --no-verify"
    - "Bash allowlist rejects disallowed commands"
    - "Bash allowlist accepts allowed commands (cat, head, tail, find, wc)"
    - "Unknown tool names return clear error"
  artifacts:
    - path: "src/orchestrator/session.test.ts"
      provides: "Comprehensive tests for all Phase 3 tools"
      contains: "edit_file"
  key_links:
    - from: "src/orchestrator/session.test.ts"
      to: "src/orchestrator/session.ts executeTool"
      via: "Direct method testing via AgentSession"
      pattern: "executeTool|edit_file|git_operation|bash_command"
---

<objective>
Write comprehensive tests for all Phase 3 tool implementations: path validation hardening, edit_file (str_replace + create), git_operation, grep, and bash_command allowlist. Tests must verify both happy paths and security rejection cases.

Purpose: Prove that tools work correctly AND that security boundaries hold (disallowed commands rejected, path traversal blocked, git hooks prevented).

Output: Updated session.test.ts with unit and integration tests covering all new tool functionality.
</objective>

<execution_context>
@/Users/kiruba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kiruba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-tool-access/03-RESEARCH.md
@.planning/phases/03-agent-tool-access/03-01-SUMMARY.md

# Source files to test against
@src/orchestrator/session.ts
@src/orchestrator/session.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for path validation and edit_file tool</name>
  <files>src/orchestrator/session.test.ts</files>
  <action>
The existing session.test.ts uses real Docker + API calls (integration tests). Phase 3 tests should follow the same pattern where possible, but path validation and edit logic can be tested more directly.

**Approach:** Since executeTool is a private method on AgentSession, test it indirectly by:
1. Creating a test helper that exercises tools through a running session
2. OR extract testable logic into separate functions/methods

**Recommended approach:** Create a focused test file OR update the existing one. Use the existing pattern of creating a real container session and calling tools through it.

Write tests for:

**Path validation hardening (5 tests):**
- Null byte in path rejected: path containing `\0` returns error
- .git/hooks access denied: path `.git/hooks/pre-commit` returns error
- node_modules/.bin access denied: path `node_modules/.bin/something` returns error
- Path traversal blocked: path `../../etc/passwd` returns error
- Valid workspace path succeeds: path `src/test.txt` works normally

**edit_file str_replace (4 tests):**
- Successful replacement: create a test file in workspace, call str_replace with unique old_str, verify file content changed
- Non-existent old_str: call str_replace with text not in file, verify error message says "not found"
- Multiple matches: create file with repeated text, call str_replace, verify error includes match count and line numbers
- Non-existent file: call str_replace on path that doesn't exist, verify error

**edit_file create (3 tests):**
- Successful create: call create with new filename and content, verify file exists with correct content
- File already exists: create a file, then try create again, verify error saying file already exists
- Create with path validation: try to create file at `../../evil.txt`, verify rejection

For testing, create temporary test files in the workspace directory before running tool calls. Clean up after.

The test pattern from the existing test file is:
```typescript
const session = new AgentSession({ workspaceDir: testDir });
await session.start();
// ... test tool calls via agent loop or direct method access
await session.stop();
```

Since executeTool is private, you have two options:
1. Use the agent loop with a specific prompt that triggers the tool (expensive, uses API credits)
2. Make executeTool accessible for testing by casting: `(session as any).executeTool('edit_file', { ... })`

Use option 2 (casting) for unit tests since it avoids API costs and is faster. Mark these as "Tool unit tests" to distinguish from E2E tests.

IMPORTANT: Before calling executeTool, you must call session.start() to initialize the container. Also manually set workspaceDir on the session instance via `(session as any).workspaceDir = testDir`.
  </action>
  <verify>
- Tests run: `npx tsx src/orchestrator/session.test.ts`
- All path validation tests pass (5 tests)
- All edit_file str_replace tests pass (4 tests)
- All edit_file create tests pass (3 tests)
  </verify>
  <done>12 tests for path validation and edit_file tool passing, covering both happy paths and security rejection cases</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for git_operation, grep, and bash_command tools</name>
  <files>src/orchestrator/session.test.ts</files>
  <action>
Continue adding tests to session.test.ts:

**git_operation (4 tests):**
- git status works: initialize a git repo in test workspace, call git_operation status, verify it returns porcelain output
- git diff works: modify a tracked file, call git_operation diff, verify diff output
- git add + commit works: add and commit a file, verify commit succeeds with --no-verify
- Unknown operation rejected: call git_operation with operation "push", verify error

**grep (3 tests):**
- Pattern found: create a test file with known content, grep for a pattern, verify matches returned with filenames and line numbers
- Pattern not found: grep for pattern not in any file, verify "(no matches found)" returned
- Case insensitive: create file with "Hello", grep for "hello" with case_insensitive: true, verify match

**bash_command (4 tests):**
- Allowed command works (cat): create a test file, call bash_command cat with file path, verify content returned
- Allowed command works (wc): create a test file, call bash_command wc, verify line count
- Disallowed command rejected: call bash_command with command "rm", verify error message lists allowed commands
- Disallowed command rejected (bash): call bash_command with command "bash", verify rejection

**Unknown tool (1 test):**
- Call executeTool with name "nonexistent_tool", verify "Unknown tool" error returned

**Test setup:**
- Create a temporary test directory for each test group
- Initialize git repo in the test directory for git tests: `git init`, `git config user.email`, `git config user.name`
- Clean up after tests

For git tests, the container needs git configured. Since the container uses `/usr/bin/git`, initialize the repo on the host (workspace is bind-mounted). Set git config for the workspace:
```bash
git -C testDir init
git -C testDir config user.email "test@test.com"
git -C testDir config user.name "Test"
```

Add a test script to package.json:
```json
"test:tools": "npx tsx src/orchestrator/session.test.ts"
```
Or update the existing test:session script if it already runs this file.
  </action>
  <verify>
- All git_operation tests pass (4 tests)
- All grep tests pass (3 tests)
- All bash_command tests pass (4 tests)
- Unknown tool test passes (1 test)
- Full test suite: `npx tsx src/orchestrator/session.test.ts` passes
  </verify>
  <done>12 additional tests for git_operation, grep, bash_command, and unknown tool passing. Total: 24 tests covering all Phase 3 tool functionality</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsx src/orchestrator/session.test.ts` passes all tests
2. Security rejection tests verify: path traversal blocked, null bytes rejected, .git/hooks denied, disallowed commands rejected
3. Happy path tests verify: edit succeeds, git operations work, grep finds patterns, allowlisted commands execute
4. No flaky tests (deterministic file creation and validation)
</verification>

<success_criteria>
- All new tests pass on a single run
- Path validation tests cover: null bytes, .git/hooks, traversal, valid paths
- edit_file tests cover: str_replace success, str_replace failures (not found, multiple matches), create success, create failure (already exists)
- git_operation tests cover: status, diff, add+commit, unknown operation rejection
- grep tests cover: match found, no match, case insensitive
- bash_command tests cover: allowed commands work, disallowed commands rejected
- Unknown tool test verifies clear error message
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-tool-access/03-02-SUMMARY.md`
</output>
