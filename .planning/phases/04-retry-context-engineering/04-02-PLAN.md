---
phase: 04-retry-context-engineering
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/orchestrator/index.ts
  - src/cli/commands/run.ts
  - src/orchestrator/retry.test.ts
  - src/orchestrator/summarizer.test.ts
autonomous: true
requirements:
  - EXEC-05
  - EXEC-06

must_haves:
  truths:
    - "CLI run command uses RetryOrchestrator instead of raw AgentSession"
    - "CLI accepts --max-retries flag with default of 3"
    - "ErrorSummarizer correctly extracts TypeScript, Jest, and ESLint error patterns"
    - "RetryOrchestrator stops on session-level failures and retries only verification failures"
    - "Retry message always includes original task first, then error digest"
    - "buildDigest caps output at 2000 chars"
  artifacts:
    - path: "src/orchestrator/index.ts"
      provides: "Exports RetryOrchestrator and ErrorSummarizer"
      contains: "RetryOrchestrator"
    - path: "src/cli/commands/run.ts"
      provides: "CLI integration using RetryOrchestrator"
      contains: "RetryOrchestrator"
    - path: "src/orchestrator/retry.test.ts"
      provides: "Unit tests for RetryOrchestrator"
      contains: "describe.*RetryOrchestrator"
    - path: "src/orchestrator/summarizer.test.ts"
      provides: "Unit tests for ErrorSummarizer"
      contains: "describe.*ErrorSummarizer"
  key_links:
    - from: "src/cli/commands/run.ts"
      to: "src/orchestrator/retry.ts"
      via: "CLI creates RetryOrchestrator and calls run()"
      pattern: "RetryOrchestrator"
    - from: "src/orchestrator/index.ts"
      to: "src/orchestrator/retry.ts"
      via: "Re-exports RetryOrchestrator"
      pattern: "export.*RetryOrchestrator"
---

<objective>
Integrate RetryOrchestrator into the CLI and create comprehensive tests for the retry and summarizer modules.

Purpose: Make the retry orchestration accessible from the CLI and verify all behavior with unit tests — particularly error summarization patterns and retry loop logic.

Output: Updated CLI run command, updated module exports, and comprehensive test suites.
</objective>

<execution_context>
@/Users/kiruba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kiruba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-retry-context-engineering/04-RESEARCH.md
@.planning/phases/04-retry-context-engineering/04-01-SUMMARY.md

@src/types.ts
@src/orchestrator/session.ts
@src/orchestrator/retry.ts
@src/orchestrator/summarizer.ts
@src/orchestrator/index.ts
@src/cli/commands/run.ts
@src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate RetryOrchestrator into CLI and update exports</name>
  <files>
    src/orchestrator/index.ts
    src/cli/commands/run.ts
    src/cli/index.ts
  </files>
  <action>
**Update `src/orchestrator/index.ts`** to export the new classes:

Add these exports:
```typescript
export { RetryOrchestrator } from './retry.js';
export { ErrorSummarizer } from './summarizer.js';
export type { VerificationError, VerificationResult, RetryConfig, RetryResult } from '../types.js';
```

**Update `src/cli/index.ts`** to add `--max-retries` option:

Add option: `.option('--max-retries <number>', 'Maximum retry attempts on verification failure (default: 3)', '3')`

Add validation in the action handler (similar to existing turnLimit/timeout validation):
```typescript
const maxRetries = parseInt(options.maxRetries, 10);
if (isNaN(maxRetries) || maxRetries < 1 || maxRetries > 10) {
  console.error(pc.red('Error: --max-retries must be a number between 1 and 10'));
  process.exit(2);
}
```

Pass `maxRetries` to `runAgent()` in the options object.

**Update `src/cli/commands/run.ts`:**

1. Add `maxRetries: number` to `RunOptions` interface (default: 3).
2. Replace `AgentSession` import with `RetryOrchestrator` import from `../../orchestrator/retry.js`.
3. Change `runAgent` to use `RetryOrchestrator` instead of raw `AgentSession`:
   - Create `RetryOrchestrator` with the same `SessionConfig` that was being passed to `AgentSession`, plus `RetryConfig` with `maxRetries` from options.
   - Call `orchestrator.run(prompt, childLogger)` instead of the current `session.start()` / `session.run()` / `session.stop()` pattern.
   - The RetryOrchestrator handles start/run/stop internally per attempt, so remove the manual lifecycle management.
4. Map `RetryResult.finalStatus` to exit codes:
   - `'success'` → 0
   - `'timeout'` → 124
   - `'max_retries_exhausted'` → 1
   - `'turn_limit'` → 1
   - `'failed'` → 1
5. Log the full `RetryResult` (attempts count, final status) in structured log output.
6. Record metrics using the final attempt's session result.
7. Signal handlers should call `orchestrator.stop?.()` if such a method exists, or simply let the finally block handle cleanup. NOTE: RetryOrchestrator manages its own session lifecycle (start/stop per attempt), so the signal handler cleanup approach needs updating — use a flag to track whether the orchestrator is running and handle SIGINT/SIGTERM by logging and exiting (the finally in RetryOrchestrator.run ensures session.stop() is called).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation. Verify RetryOrchestrator is used in run.ts: `grep 'RetryOrchestrator' src/cli/commands/run.ts`.
  </verify>
  <done>
    CLI run command uses RetryOrchestrator. --max-retries flag is accepted and validated. Module exports include RetryOrchestrator and ErrorSummarizer. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive tests for ErrorSummarizer and RetryOrchestrator</name>
  <files>
    src/orchestrator/summarizer.test.ts
    src/orchestrator/retry.test.ts
  </files>
  <action>
**Create `src/orchestrator/summarizer.test.ts`** with tests for ErrorSummarizer:

Use `import { describe, it, expect } from 'vitest';` (or the project's existing test framework — check package.json).

Test `summarizeBuildErrors`:
- TypeScript errors: input with `file.ts(10,5): error TS2345: ...` lines, verify extraction
- Generic error fallback: input with "error" lines but no TS format
- No errors found: returns fallback message
- Caps at 5 errors with "more" indicator
- Multi-line input with many TS errors

Test `summarizeTestFailures`:
- Jest bullet failures: input with `● Suite > test` lines
- Jest summary line: `Tests: 3 failed, 12 passed`
- Mocha format: `N failing`
- Fallback to FAIL/FAILED lines
- No recognizable format: returns fallback
- Caps at 5 failures

Test `summarizeLintErrors`:
- ESLint format: `3:10  error  no-unused-vars`
- File count tracking
- Caps at 5 errors
- No errors: returns fallback

Test `buildDigest`:
- Single failed result: outputs `[TYPE] summary`
- Multiple failed results: all errors included
- Passed results are skipped
- Truncation at 2000 chars: create input that would exceed 2000 chars, verify output ends with truncation notice
- Empty input: returns empty string

**Create `src/orchestrator/retry.test.ts`** with tests for RetryOrchestrator:

These are unit tests using mocks — do NOT call the real Anthropic API or Docker.

Mock `AgentSession` by mocking the `./session.js` module:
- Mock `start()` to resolve immediately
- Mock `stop()` to resolve immediately
- Mock `run()` to return configurable `SessionResult`

Test scenarios:

1. **Success on first attempt (no verifier):** verifier is undefined, session succeeds → RetryResult.finalStatus='success', attempts=1
2. **Success on first attempt (verifier passes):** session succeeds, verifier returns passed=true → success, attempts=1
3. **Retry on verification failure, then succeed:** attempt 1 session succeeds but verifier fails, attempt 2 session succeeds and verifier passes → success, attempts=2
4. **Max retries exhausted:** all 3 attempts have session success but verifier fails → max_retries_exhausted, attempts=3
5. **Session timeout stops retrying:** session returns status='timeout' → finalStatus='timeout', attempts=1, no retry
6. **Session turn_limit stops retrying:** session returns status='turn_limit' → finalStatus='turn_limit', attempts=1
7. **Session failed stops retrying:** session returns status='failed' → finalStatus='failed', attempts=1
8. **Retry message includes original task first:** verify buildRetryMessage output starts with original task, contains error digest
9. **Fresh session per attempt:** verify AgentSession constructor called once per attempt (track call count on mock)
10. **Custom maxRetries honored:** set maxRetries=2, verify only 2 attempts max

For each test, verify:
- `result.attempts` is correct
- `result.finalStatus` is correct
- `result.sessionResults.length` matches attempts
- `result.verificationResults.length` matches verification runs
- `result.error` is set appropriately

Use `vi.mock` or equivalent to mock AgentSession. Mock the verifier function directly (it's a callback, not a class).
  </action>
  <verify>
    Run `npx vitest run src/orchestrator/summarizer.test.ts src/orchestrator/retry.test.ts` (or the project's test runner). All tests pass.
  </verify>
  <done>
    summarizer.test.ts has 15+ tests covering all 4 ErrorSummarizer methods including edge cases and truncation. retry.test.ts has 10+ tests covering success, retry, exhaustion, session failures, and message construction. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All tests pass: `npx vitest run src/orchestrator/summarizer.test.ts src/orchestrator/retry.test.ts`
3. CLI accepts `--max-retries` flag: `node dist/cli/index.js --help` shows the option
4. `src/orchestrator/index.ts` exports RetryOrchestrator and ErrorSummarizer
5. `src/cli/commands/run.ts` uses RetryOrchestrator (not raw AgentSession)
</verification>

<success_criteria>
- CLI uses RetryOrchestrator for all agent runs
- --max-retries flag works with default of 3, validated 1-10
- ErrorSummarizer tests verify regex patterns for TS, Jest, ESLint output
- RetryOrchestrator tests verify retry logic with mocked sessions
- All tests pass without hitting real API or Docker
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-retry-context-engineering/04-02-SUMMARY.md`
</output>
